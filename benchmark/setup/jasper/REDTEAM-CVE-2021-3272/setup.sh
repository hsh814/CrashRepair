#!/bin/bash
BUG_DIR=/data/vulnloc/jasper/REDTEAM-CVE-2021-3272
PROJECT_URL=https://github.com/jasper-software/jasper.git
BUG_COMMIT_ID=9a2835a81ce9c41a48f36dadce79f110da8d6c75

mkdir -p ${BUG_DIR}
pushd ${BUG_DIR}

git clone ${PROJECT_URL} src
pushd src
git checkout ${BUG_COMMIT_ID}

cmake -G'Unix Makefiles' -DJAS_ENABLE_SHARED=OFF -DALLOW_IN_SOURCE_BUILD=ON -DBUILD_SHARED_LIBS=OFF .
make -j32

clang -I ./src/libjasper/include -E src/libjasper/jp2/jp2_dec.c > src/libjasper/jp2/jp2_dec.c.pre
grep -v '^ *#' src/libjasper/jp2/jp2_dec.c.pre > src/libjasper/jp2/jp2_dec.c

# CT: removing these files causes "make clean" to fail
# rm CMakeCache.txt
# rm -rf CMakeFiles/


